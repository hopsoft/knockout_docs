<!DOCTYPE html>

<html>
<head>
  <title>options.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="bindingAttributeSyntax.html">
                bindingAttributeSyntax.js
              </a>
            
              
              <a class="source" href="bindingProvider.html">
                bindingProvider.js
              </a>
            
              
              <a class="source" href="attr.html">
                attr.js
              </a>
            
              
              <a class="source" href="checked.html">
                checked.js
              </a>
            
              
              <a class="source" href="click.html">
                click.js
              </a>
            
              
              <a class="source" href="css.html">
                css.js
              </a>
            
              
              <a class="source" href="enableDisable.html">
                enableDisable.js
              </a>
            
              
              <a class="source" href="event.html">
                event.js
              </a>
            
              
              <a class="source" href="foreach.html">
                foreach.js
              </a>
            
              
              <a class="source" href="hasfocus.html">
                hasfocus.js
              </a>
            
              
              <a class="source" href="html.html">
                html.js
              </a>
            
              
              <a class="source" href="ifIfnotWith.html">
                ifIfnotWith.js
              </a>
            
              
              <a class="source" href="options.html">
                options.js
              </a>
            
              
              <a class="source" href="selectedOptions.html">
                selectedOptions.js
              </a>
            
              
              <a class="source" href="style.html">
                style.js
              </a>
            
              
              <a class="source" href="submit.html">
                submit.js
              </a>
            
              
              <a class="source" href="text.html">
                text.js
              </a>
            
              
              <a class="source" href="uniqueName.html">
                uniqueName.js
              </a>
            
              
              <a class="source" href="value.html">
                value.js
              </a>
            
              
              <a class="source" href="visible.html">
                visible.js
              </a>
            
              
              <a class="source" href="arrayToDomNodeChildren.html">
                arrayToDomNodeChildren.js
              </a>
            
              
              <a class="source" href="compareArrays.html">
                compareArrays.js
              </a>
            
              
              <a class="source" href="expressionRewriting.html">
                expressionRewriting.js
              </a>
            
              
              <a class="source" href="selectExtensions.html">
                selectExtensions.js
              </a>
            
              
              <a class="source" href="google-closure-compiler-utils.html">
                google-closure-compiler-utils.js
              </a>
            
              
              <a class="source" href="memoization.html">
                memoization.js
              </a>
            
              
              <a class="source" href="namespace.html">
                namespace.js
              </a>
            
              
              <a class="source" href="dependencyDetection.html">
                dependencyDetection.js
              </a>
            
              
              <a class="source" href="dependentObservable.html">
                dependentObservable.js
              </a>
            
              
              <a class="source" href="extenders.html">
                extenders.js
              </a>
            
              
              <a class="source" href="mappingHelpers.html">
                mappingHelpers.js
              </a>
            
              
              <a class="source" href="observable.html">
                observable.js
              </a>
            
              
              <a class="source" href="observableArray.html">
                observableArray.js
              </a>
            
              
              <a class="source" href="subscribable.html">
                subscribable.js
              </a>
            
              
              <a class="source" href="jqueryTmplTemplateEngine.html">
                jqueryTmplTemplateEngine.js
              </a>
            
              
              <a class="source" href="nativeTemplateEngine.html">
                nativeTemplateEngine.js
              </a>
            
              
              <a class="source" href="templateEngine.html">
                templateEngine.js
              </a>
            
              
              <a class="source" href="templateRewriting.html">
                templateRewriting.js
              </a>
            
              
              <a class="source" href="templateSources.html">
                templateSources.js
              </a>
            
              
              <a class="source" href="templating.html">
                templating.js
              </a>
            
              
              <a class="source" href="utils.domData.html">
                utils.domData.js
              </a>
            
              
              <a class="source" href="utils.domManipulation.html">
                utils.domManipulation.js
              </a>
            
              
              <a class="source" href="utils.domNodeDisposal.html">
                utils.domNodeDisposal.js
              </a>
            
              
              <a class="source" href="utils.html">
                utils.js
              </a>
            
              
              <a class="source" href="version.html">
                version.js
              </a>
            
              
              <a class="source" href="virtualElements.html">
                virtualElements.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>options.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">ensureDropdownSelectionIsConsistentWithModelValue</span><span class="params">(element, modelValue, preferModelValue)</span> {</span>
    <span class="keyword">if</span> (preferModelValue) {
        <span class="keyword">if</span> (modelValue !== ko.selectExtensions.readValue(element))
            ko.selectExtensions.writeValue(element, modelValue);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>No matter which direction we&#39;re syncing in, we want the end result to be equality between dropdown value and model value.
If they aren&#39;t equal, either we prefer the dropdown value, or the model value couldn&#39;t be represented, so either way,
change the model value to match the dropdown.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (modelValue !== ko.selectExtensions.readValue(element))
        ko.dependencyDetection.ignore(ko.utils.triggerEvent, <span class="literal">null</span>, [element, <span class="string">"change"</span>]);
};

ko.bindingHandlers[<span class="string">'options'</span>] = {
    <span class="string">'init'</span>: <span class="keyword">function</span>(element) {
        <span class="keyword">if</span> (ko.utils.tagNameLower(element) !== <span class="string">"select"</span>)
            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"options binding applies only to SELECT elements"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Remove all existing <option>s.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">while</span> (element.length &gt; <span class="number">0</span>) {
            element.remove(<span class="number">0</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Ensures that the binding processor doesn&#39;t try to bind the options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> { <span class="string">'controlsDescendantBindings'</span>: <span class="literal">true</span> };
    },
    <span class="string">'update'</span>: <span class="function"><span class="keyword">function</span> <span class="params">(element, valueAccessor, allBindingsAccessor)</span> {</span>
        <span class="keyword">var</span> selectWasPreviouslyEmpty = element.length == <span class="number">0</span>;
        <span class="keyword">var</span> previousScrollTop = (!selectWasPreviouslyEmpty &amp;&amp; element.multiple) ? element.scrollTop : <span class="literal">null</span>;

        <span class="keyword">var</span> unwrappedArray = ko.utils.unwrapObservable(valueAccessor());
        <span class="keyword">var</span> allBindings = allBindingsAccessor();
        <span class="keyword">var</span> includeDestroyed = allBindings[<span class="string">'optionsIncludeDestroyed'</span>];
        <span class="keyword">var</span> captionPlaceholder = {};
        <span class="keyword">var</span> captionValue;
        <span class="keyword">var</span> previousSelectedValues;
        <span class="keyword">if</span> (element.multiple) {
            previousSelectedValues = ko.utils.arrayMap(element.selectedOptions || ko.utils.arrayFilter(element.childNodes, <span class="function"><span class="keyword">function</span> <span class="params">(node)</span> {</span>
                    <span class="keyword">return</span> node.tagName &amp;&amp; (ko.utils.tagNameLower(node) === <span class="string">"option"</span>) &amp;&amp; node.selected;
                }), <span class="function"><span class="keyword">function</span> <span class="params">(node)</span> {</span>
                    <span class="keyword">return</span> ko.selectExtensions.readValue(node);
                });
        } <span class="keyword">else</span> <span class="keyword">if</span> (element.selectedIndex &gt;= <span class="number">0</span>) {
            previousSelectedValues = [ ko.selectExtensions.readValue(element.options[element.selectedIndex]) ];
        }

        <span class="keyword">if</span> (unwrappedArray) {
            <span class="keyword">if</span> (<span class="keyword">typeof</span> unwrappedArray.length == <span class="string">"undefined"</span>) <span class="comment">// Coerce single value into array</span>
                unwrappedArray = [unwrappedArray];</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Filter out any entries marked as destroyed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> filteredArray = ko.utils.arrayFilter(unwrappedArray, <span class="keyword">function</span>(item) {
                <span class="keyword">return</span> includeDestroyed || item === <span class="literal">undefined</span> || item === <span class="literal">null</span> || !ko.utils.unwrapObservable(item[<span class="string">'_destroy'</span>]);
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>If caption is included, add it to the array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="string">'optionsCaption'</span> <span class="keyword">in</span> allBindings) {
                captionValue = ko.utils.unwrapObservable(allBindings[<span class="string">'optionsCaption'</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>If caption value is null or undefined, don&#39;t show a caption</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (captionValue !== <span class="literal">null</span> &amp;&amp; captionValue !== <span class="literal">undefined</span>) {
                    filteredArray.unshift(captionPlaceholder);
                }
            }
        } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>If a falsy value is provided (e.g. null), we&#39;ll simply empty the select element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            unwrappedArray = [];
        }

        <span class="function"><span class="keyword">function</span> <span class="title">applyToObject</span><span class="params">(object, predicate, defaultValue)</span> {</span>
            <span class="keyword">var</span> predicateType = <span class="keyword">typeof</span> predicate;
            <span class="keyword">if</span> (predicateType == <span class="string">"function"</span>)    <span class="comment">// Given a function; run it against the data value</span>
                <span class="keyword">return</span> predicate(object);
            <span class="keyword">else</span> <span class="keyword">if</span> (predicateType == <span class="string">"string"</span>) <span class="comment">// Given a string; treat it as a property name on the data value</span>
                <span class="keyword">return</span> object[predicate];
            <span class="keyword">else</span>                                <span class="comment">// Given no optionsText arg; use the data value itself</span>
                <span class="keyword">return</span> defaultValue;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>The following functions can run at two different times:
The first is when the whole array is being updated directly from this binding handler.
The second is when an observable value for a specific array entry is updated.
oldOptions will be empty in the first case, but will be filled with the previously generated option in the second.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="function"><span class="keyword">function</span> <span class="title">optionForArrayItem</span><span class="params">(arrayEntry, index, oldOptions)</span> {</span>
            <span class="keyword">if</span> (oldOptions.length) {
                previousSelectedValues = oldOptions[<span class="number">0</span>].selected &amp;&amp; [ ko.selectExtensions.readValue(oldOptions[<span class="number">0</span>]) ];
            }
            <span class="keyword">var</span> option = document.createElement(<span class="string">"option"</span>);
            <span class="keyword">if</span> (arrayEntry === captionPlaceholder) {
                ko.utils.setHtml(option, captionValue);
                ko.selectExtensions.writeValue(option, <span class="literal">undefined</span>);
            } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Apply a value to the option element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> optionValue = applyToObject(arrayEntry, allBindings[<span class="string">'optionsValue'</span>], arrayEntry);
                ko.selectExtensions.writeValue(option, ko.utils.unwrapObservable(optionValue));</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Apply some text to the option element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> optionText = applyToObject(arrayEntry, allBindings[<span class="string">'optionsText'</span>], optionValue);
                ko.utils.setTextContent(option, optionText);
            }
            <span class="keyword">return</span> [option];
        }

        <span class="function"><span class="keyword">function</span> <span class="title">setSelectionCallback</span><span class="params">(arrayEntry, newOptions)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>IE6 doesn&#39;t like us to assign selection to OPTION nodes before they&#39;re added to the document.
That&#39;s why we first added them without selection. Now it&#39;s time to set the selection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (previousSelectedValues) {
                <span class="keyword">var</span> isSelected = ko.utils.arrayIndexOf(previousSelectedValues, ko.selectExtensions.readValue(newOptions[<span class="number">0</span>])) &gt;= <span class="number">0</span>;
                ko.utils.setOptionNodeSelectionState(newOptions[<span class="number">0</span>], isSelected);
            }
        }

        <span class="keyword">var</span> callback = setSelectionCallback;
        <span class="keyword">if</span> (allBindings[<span class="string">'optionsAfterRender'</span>]) {
            callback = <span class="keyword">function</span>(arrayEntry, newOptions) {
                setSelectionCallback(arrayEntry, newOptions);
                ko.dependencyDetection.ignore(allBindings[<span class="string">'optionsAfterRender'</span>], <span class="literal">null</span>, [newOptions[<span class="number">0</span>], arrayEntry !== captionPlaceholder ? arrayEntry : <span class="literal">undefined</span>]);
            }
        }

        ko.utils.setDomNodeChildrenFromArrayMapping(element, filteredArray, optionForArrayItem, <span class="literal">null</span>, callback);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Clear previousSelectedValues so that future updates to individual objects don&#39;t get stale data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        previousSelectedValues = <span class="literal">null</span>;

        <span class="keyword">if</span> (selectWasPreviouslyEmpty &amp;&amp; (<span class="string">'value'</span> <span class="keyword">in</span> allBindings)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Ensure consistency between model value and selected option.
If the dropdown is being populated for the first time here (or was otherwise previously empty),
the dropdown selection state is meaningless, so we preserve the model value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            ensureDropdownSelectionIsConsistentWithModelValue(element, ko.utils.peekObservable(allBindings[<span class="string">'value'</span>]), <span class="comment">/* preferModelValue */</span> <span class="literal">true</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Workaround for IE bug</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ko.utils.ensureSelectElementIsRenderedCorrectly(element);

        <span class="keyword">if</span> (previousScrollTop &amp;&amp; Math.abs(previousScrollTop - element.scrollTop) &gt; <span class="number">20</span>)
            element.scrollTop = previousScrollTop;
    }
};
ko.bindingHandlers[<span class="string">'options'</span>].optionValueDomDataKey = <span class="string">'__ko.optionValueDomData__'</span>;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
