<!DOCTYPE html>

<html>
<head>
  <title>utils.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="bindingAttributeSyntax.html">
                bindingAttributeSyntax.js
              </a>
            
              
              <a class="source" href="bindingProvider.html">
                bindingProvider.js
              </a>
            
              
              <a class="source" href="attr.html">
                attr.js
              </a>
            
              
              <a class="source" href="checked.html">
                checked.js
              </a>
            
              
              <a class="source" href="click.html">
                click.js
              </a>
            
              
              <a class="source" href="css.html">
                css.js
              </a>
            
              
              <a class="source" href="enableDisable.html">
                enableDisable.js
              </a>
            
              
              <a class="source" href="event.html">
                event.js
              </a>
            
              
              <a class="source" href="foreach.html">
                foreach.js
              </a>
            
              
              <a class="source" href="hasfocus.html">
                hasfocus.js
              </a>
            
              
              <a class="source" href="html.html">
                html.js
              </a>
            
              
              <a class="source" href="ifIfnotWith.html">
                ifIfnotWith.js
              </a>
            
              
              <a class="source" href="options.html">
                options.js
              </a>
            
              
              <a class="source" href="selectedOptions.html">
                selectedOptions.js
              </a>
            
              
              <a class="source" href="style.html">
                style.js
              </a>
            
              
              <a class="source" href="submit.html">
                submit.js
              </a>
            
              
              <a class="source" href="text.html">
                text.js
              </a>
            
              
              <a class="source" href="uniqueName.html">
                uniqueName.js
              </a>
            
              
              <a class="source" href="value.html">
                value.js
              </a>
            
              
              <a class="source" href="visible.html">
                visible.js
              </a>
            
              
              <a class="source" href="arrayToDomNodeChildren.html">
                arrayToDomNodeChildren.js
              </a>
            
              
              <a class="source" href="compareArrays.html">
                compareArrays.js
              </a>
            
              
              <a class="source" href="expressionRewriting.html">
                expressionRewriting.js
              </a>
            
              
              <a class="source" href="selectExtensions.html">
                selectExtensions.js
              </a>
            
              
              <a class="source" href="google-closure-compiler-utils.html">
                google-closure-compiler-utils.js
              </a>
            
              
              <a class="source" href="memoization.html">
                memoization.js
              </a>
            
              
              <a class="source" href="namespace.html">
                namespace.js
              </a>
            
              
              <a class="source" href="dependencyDetection.html">
                dependencyDetection.js
              </a>
            
              
              <a class="source" href="dependentObservable.html">
                dependentObservable.js
              </a>
            
              
              <a class="source" href="extenders.html">
                extenders.js
              </a>
            
              
              <a class="source" href="mappingHelpers.html">
                mappingHelpers.js
              </a>
            
              
              <a class="source" href="observable.html">
                observable.js
              </a>
            
              
              <a class="source" href="observableArray.html">
                observableArray.js
              </a>
            
              
              <a class="source" href="subscribable.html">
                subscribable.js
              </a>
            
              
              <a class="source" href="jqueryTmplTemplateEngine.html">
                jqueryTmplTemplateEngine.js
              </a>
            
              
              <a class="source" href="nativeTemplateEngine.html">
                nativeTemplateEngine.js
              </a>
            
              
              <a class="source" href="templateEngine.html">
                templateEngine.js
              </a>
            
              
              <a class="source" href="templateRewriting.html">
                templateRewriting.js
              </a>
            
              
              <a class="source" href="templateSources.html">
                templateSources.js
              </a>
            
              
              <a class="source" href="templating.html">
                templating.js
              </a>
            
              
              <a class="source" href="utils.domData.html">
                utils.domData.js
              </a>
            
              
              <a class="source" href="utils.domManipulation.html">
                utils.domManipulation.js
              </a>
            
              
              <a class="source" href="utils.domNodeDisposal.html">
                utils.domNodeDisposal.js
              </a>
            
              
              <a class="source" href="utils.html">
                utils.js
              </a>
            
              
              <a class="source" href="version.html">
                version.js
              </a>
            
              
              <a class="source" href="virtualElements.html">
                virtualElements.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>utils.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>ko.utils = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> objectForEach = <span class="keyword">function</span>(obj, action) {
        <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> obj) {
            <span class="keyword">if</span> (obj.hasOwnProperty(prop)) {
                action(prop, obj[prop]);
            }
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Represent the known event types in a compact way, then at runtime transform it into a hash with event name as key (for fast lookup)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> knownEvents = {}, knownEventTypesByEventName = {};
    <span class="keyword">var</span> keyEventTypeName = (navigator &amp;&amp; <span class="regexp">/Firefox\/2/i</span>.test(navigator.userAgent)) ? <span class="string">'KeyboardEvent'</span> : <span class="string">'UIEvents'</span>;
    knownEvents[keyEventTypeName] = [<span class="string">'keyup'</span>, <span class="string">'keydown'</span>, <span class="string">'keypress'</span>];
    knownEvents[<span class="string">'MouseEvents'</span>] = [<span class="string">'click'</span>, <span class="string">'dblclick'</span>, <span class="string">'mousedown'</span>, <span class="string">'mouseup'</span>, <span class="string">'mousemove'</span>, <span class="string">'mouseover'</span>, <span class="string">'mouseout'</span>, <span class="string">'mouseenter'</span>, <span class="string">'mouseleave'</span>];
    objectForEach(knownEvents, <span class="keyword">function</span>(eventType, knownEventsForType) {
        <span class="keyword">if</span> (knownEventsForType.length) {
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = knownEventsForType.length; i &lt; j; i++)
                knownEventTypesByEventName[knownEventsForType[i]] = eventType;
        }
    });
    <span class="keyword">var</span> eventsThatMustBeRegisteredUsingAttachEvent = { <span class="string">'propertychange'</span>: <span class="literal">true</span> }; <span class="comment">// Workaround for an IE9 issue - https://github.com/SteveSanderson/knockout/issues/406</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Detect IE versions for bug workarounds (uses IE conditionals, not UA string, for robustness)
Note that, since IE 10 does not support conditional comments, the following logic only detects IE &lt; 10.
Currently this is by design, since IE 10+ behaves correctly when treated as a standard browser.
If there is a future need to detect specific versions of IE10+, we will amend this.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> ieVersion = document &amp;&amp; (<span class="keyword">function</span>() {
        <span class="keyword">var</span> version = <span class="number">3</span>, div = document.createElement(<span class="string">'div'</span>), iElems = div.getElementsByTagName(<span class="string">'i'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Keep constructing conditional HTML blocks until we hit one that resolves to an empty fragment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">while</span> (
            div.innerHTML = <span class="string">'&lt;!--[if gt IE '</span> + (++version) + <span class="string">']&gt;&lt;i&gt;&lt;/i&gt;&lt;![endif]--&gt;'</span>,
            iElems[<span class="number">0</span>]
        ) {}
        <span class="keyword">return</span> version &gt; <span class="number">4</span> ? version : <span class="literal">undefined</span>;
    }());
    <span class="keyword">var</span> isIe6 = ieVersion === <span class="number">6</span>,
        isIe7 = ieVersion === <span class="number">7</span>;

    <span class="function"><span class="keyword">function</span> <span class="title">isClickOnCheckableElement</span><span class="params">(element, eventType)</span> {</span>
        <span class="keyword">if</span> ((ko.utils.tagNameLower(element) !== <span class="string">"input"</span>) || !element.type) <span class="keyword">return</span> <span class="literal">false</span>;
        <span class="keyword">if</span> (eventType.toLowerCase() != <span class="string">"click"</span>) <span class="keyword">return</span> <span class="literal">false</span>;
        <span class="keyword">var</span> inputType = element.type;
        <span class="keyword">return</span> (inputType == <span class="string">"checkbox"</span>) || (inputType == <span class="string">"radio"</span>);
    }

    <span class="keyword">return</span> {
        fieldsIncludedWithJsonPost: [<span class="string">'authenticity_token'</span>, <span class="regexp">/^__RequestVerificationToken(_.*)?$/</span>],

        arrayForEach: <span class="function"><span class="keyword">function</span> <span class="params">(array, action)</span> {</span>
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = array.length; i &lt; j; i++)
                action(array[i]);
        },

        arrayIndexOf: <span class="function"><span class="keyword">function</span> <span class="params">(array, item)</span> {</span>
            <span class="keyword">if</span> (<span class="keyword">typeof</span> Array.prototype.indexOf == <span class="string">"function"</span>)
                <span class="keyword">return</span> Array.prototype.indexOf.call(array, item);
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = array.length; i &lt; j; i++)
                <span class="keyword">if</span> (array[i] === item)
                    <span class="keyword">return</span> i;
            <span class="keyword">return</span> -<span class="number">1</span>;
        },

        arrayFirst: <span class="function"><span class="keyword">function</span> <span class="params">(array, predicate, predicateOwner)</span> {</span>
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = array.length; i &lt; j; i++)
                <span class="keyword">if</span> (predicate.call(predicateOwner, array[i]))
                    <span class="keyword">return</span> array[i];
            <span class="keyword">return</span> <span class="literal">null</span>;
        },

        arrayRemoveItem: <span class="function"><span class="keyword">function</span> <span class="params">(array, itemToRemove)</span> {</span>
            <span class="keyword">var</span> index = ko.utils.arrayIndexOf(array, itemToRemove);
            <span class="keyword">if</span> (index &gt;= <span class="number">0</span>)
                array.splice(index, <span class="number">1</span>);
        },

        arrayGetDistinctValues: <span class="function"><span class="keyword">function</span> <span class="params">(array)</span> {</span>
            array = array || [];
            <span class="keyword">var</span> result = [];
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = array.length; i &lt; j; i++) {
                <span class="keyword">if</span> (ko.utils.arrayIndexOf(result, array[i]) &lt; <span class="number">0</span>)
                    result.push(array[i]);
            }
            <span class="keyword">return</span> result;
        },

        arrayMap: <span class="function"><span class="keyword">function</span> <span class="params">(array, mapping)</span> {</span>
            array = array || [];
            <span class="keyword">var</span> result = [];
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = array.length; i &lt; j; i++)
                result.push(mapping(array[i]));
            <span class="keyword">return</span> result;
        },

        arrayFilter: <span class="function"><span class="keyword">function</span> <span class="params">(array, predicate)</span> {</span>
            array = array || [];
            <span class="keyword">var</span> result = [];
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = array.length; i &lt; j; i++)
                <span class="keyword">if</span> (predicate(array[i]))
                    result.push(array[i]);
            <span class="keyword">return</span> result;
        },

        arrayPushAll: <span class="function"><span class="keyword">function</span> <span class="params">(array, valuesToPush)</span> {</span>
            <span class="keyword">if</span> (valuesToPush <span class="keyword">instanceof</span> Array)
                array.push.apply(array, valuesToPush);
            <span class="keyword">else</span>
                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = valuesToPush.length; i &lt; j; i++)
                    array.push(valuesToPush[i]);
            <span class="keyword">return</span> array;
        },

        addOrRemoveItem: <span class="keyword">function</span>(array, value, included) {
            <span class="keyword">var</span> existingEntryIndex = array.indexOf ? array.indexOf(value) : ko.utils.arrayIndexOf(array, value);
            <span class="keyword">if</span> (existingEntryIndex &lt; <span class="number">0</span>) {
                <span class="keyword">if</span> (included)
                    array.push(value);
            } <span class="keyword">else</span> {
                <span class="keyword">if</span> (!included)
                    array.splice(existingEntryIndex, <span class="number">1</span>);
            }
        },

        extend: <span class="function"><span class="keyword">function</span> <span class="params">(target, source)</span> {</span>
            <span class="keyword">if</span> (source) {
                <span class="keyword">for</span>(<span class="keyword">var</span> prop <span class="keyword">in</span> source) {
                    <span class="keyword">if</span>(source.hasOwnProperty(prop)) {
                        target[prop] = source[prop];
                    }
                }
            }
            <span class="keyword">return</span> target;
        },

        objectForEach: objectForEach,

        emptyDomNode: <span class="function"><span class="keyword">function</span> <span class="params">(domNode)</span> {</span>
            <span class="keyword">while</span> (domNode.firstChild) {
                ko.removeNode(domNode.firstChild);
            }
        },

        moveCleanedNodesToContainerElement: <span class="keyword">function</span>(nodes) {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Ensure it&#39;s a real array, as we&#39;re about to reparent the nodes and
we don&#39;t want the underlying collection to change while we&#39;re doing that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> nodesArray = ko.utils.makeArray(nodes);

            <span class="keyword">var</span> container = document.createElement(<span class="string">'div'</span>);
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = nodesArray.length; i &lt; j; i++) {
                container.appendChild(ko.cleanNode(nodesArray[i]));
            }
            <span class="keyword">return</span> container;
        },

        cloneNodes: <span class="function"><span class="keyword">function</span> <span class="params">(nodesArray, shouldCleanNodes)</span> {</span>
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = nodesArray.length, newNodesArray = []; i &lt; j; i++) {
                <span class="keyword">var</span> clonedNode = nodesArray[i].cloneNode(<span class="literal">true</span>);
                newNodesArray.push(shouldCleanNodes ? ko.cleanNode(clonedNode) : clonedNode);
            }
            <span class="keyword">return</span> newNodesArray;
        },

        setDomNodeChildren: <span class="function"><span class="keyword">function</span> <span class="params">(domNode, childNodes)</span> {</span>
            ko.utils.emptyDomNode(domNode);
            <span class="keyword">if</span> (childNodes) {
                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = childNodes.length; i &lt; j; i++)
                    domNode.appendChild(childNodes[i]);
            }
        },

        replaceDomNodes: <span class="function"><span class="keyword">function</span> <span class="params">(nodeToReplaceOrNodeArray, newNodesArray)</span> {</span>
            <span class="keyword">var</span> nodesToReplaceArray = nodeToReplaceOrNodeArray.nodeType ? [nodeToReplaceOrNodeArray] : nodeToReplaceOrNodeArray;
            <span class="keyword">if</span> (nodesToReplaceArray.length &gt; <span class="number">0</span>) {
                <span class="keyword">var</span> insertionPoint = nodesToReplaceArray[<span class="number">0</span>];
                <span class="keyword">var</span> parent = insertionPoint.parentNode;
                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = newNodesArray.length; i &lt; j; i++)
                    parent.insertBefore(newNodesArray[i], insertionPoint);
                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = nodesToReplaceArray.length; i &lt; j; i++) {
                    ko.removeNode(nodesToReplaceArray[i]);
                }
            }
        },

        setOptionNodeSelectionState: <span class="function"><span class="keyword">function</span> <span class="params">(optionNode, isSelected)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>IE6 sometimes throws &quot;unknown error&quot; if you try to write to .selected directly, whereas Firefox struggles with setAttribute. Pick one based on browser.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (ieVersion &lt; <span class="number">7</span>)
                optionNode.setAttribute(<span class="string">"selected"</span>, isSelected);
            <span class="keyword">else</span>
                optionNode.selected = isSelected;
        },

        stringTrim: <span class="function"><span class="keyword">function</span> <span class="params">(string)</span> {</span>
            <span class="keyword">return</span> string === <span class="literal">null</span> || string === <span class="literal">undefined</span> ? <span class="string">''</span> :
                string.trim ?
                    string.trim() :
                    string.toString().replace(<span class="regexp">/^[\s\xa0]+|[\s\xa0]+$/g</span>, <span class="string">''</span>);
        },

        stringTokenize: <span class="function"><span class="keyword">function</span> <span class="params">(string, delimiter)</span> {</span>
            <span class="keyword">var</span> result = [];
            <span class="keyword">var</span> tokens = (string || <span class="string">""</span>).split(delimiter);
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = tokens.length; i &lt; j; i++) {
                <span class="keyword">var</span> trimmed = ko.utils.stringTrim(tokens[i]);
                <span class="keyword">if</span> (trimmed !== <span class="string">""</span>)
                    result.push(trimmed);
            }
            <span class="keyword">return</span> result;
        },

        stringStartsWith: <span class="function"><span class="keyword">function</span> <span class="params">(string, startsWith)</span> {</span>
            string = string || <span class="string">""</span>;
            <span class="keyword">if</span> (startsWith.length &gt; string.length)
                <span class="keyword">return</span> <span class="literal">false</span>;
            <span class="keyword">return</span> string.substring(<span class="number">0</span>, startsWith.length) === startsWith;
        },

        domNodeIsContainedBy: <span class="function"><span class="keyword">function</span> <span class="params">(node, containedByNode)</span> {</span>
            <span class="keyword">if</span> (containedByNode.compareDocumentPosition)
                <span class="keyword">return</span> (containedByNode.compareDocumentPosition(node) &amp; <span class="number">16</span>) == <span class="number">16</span>;
            <span class="keyword">while</span> (node != <span class="literal">null</span>) {
                <span class="keyword">if</span> (node == containedByNode)
                    <span class="keyword">return</span> <span class="literal">true</span>;
                node = node.parentNode;
            }
            <span class="keyword">return</span> <span class="literal">false</span>;
        },

        domNodeIsAttachedToDocument: <span class="function"><span class="keyword">function</span> <span class="params">(node)</span> {</span>
            <span class="keyword">return</span> ko.utils.domNodeIsContainedBy(node, node.ownerDocument);
        },

        anyDomNodeIsAttachedToDocument: <span class="keyword">function</span>(nodes) {
            <span class="keyword">return</span> !!ko.utils.arrayFirst(nodes, ko.utils.domNodeIsAttachedToDocument);
        },

        tagNameLower: <span class="keyword">function</span>(element) {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>For HTML elements, tagName will always be upper case; for XHTML elements, it&#39;ll be lower case.
Possible future optimization: If we know it&#39;s an element from an XHTML document (not HTML),
we don&#39;t need to do the .toLowerCase() as it will always be lower case anyway.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> element &amp;&amp; element.tagName &amp;&amp; element.tagName.toLowerCase();
        },

        registerEventHandler: <span class="function"><span class="keyword">function</span> <span class="params">(element, eventType, handler)</span> {</span>
            <span class="keyword">var</span> mustUseAttachEvent = ieVersion &amp;&amp; eventsThatMustBeRegisteredUsingAttachEvent[eventType];
            <span class="keyword">if</span> (!mustUseAttachEvent &amp;&amp; <span class="keyword">typeof</span> jQuery != <span class="string">"undefined"</span>) {
                <span class="keyword">if</span> (isClickOnCheckableElement(element, eventType)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>For click events on checkboxes, jQuery interferes with the event handling in an awkward way:
it toggles the element checked state <em>after</em> the click event handlers run, whereas native
click events toggle the checked state <em>before</em> the event handler.
Fix this by intecepting the handler and applying the correct checkedness before it runs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> originalHandler = handler;
                    handler = <span class="keyword">function</span>(event, eventData) {
                        <span class="keyword">var</span> jQuerySuppliedCheckedState = <span class="keyword">this</span>.checked;
                        <span class="keyword">if</span> (eventData)
                            <span class="keyword">this</span>.checked = eventData.checkedStateBeforeEvent !== <span class="literal">true</span>;
                        originalHandler.call(<span class="keyword">this</span>, event);
                        <span class="keyword">this</span>.checked = jQuerySuppliedCheckedState; <span class="comment">// Restore the state jQuery applied</span>
                    };
                }
                jQuery(element)[<span class="string">'bind'</span>](eventType, handler);
            } <span class="keyword">else</span> <span class="keyword">if</span> (!mustUseAttachEvent &amp;&amp; <span class="keyword">typeof</span> element.addEventListener == <span class="string">"function"</span>)
                element.addEventListener(eventType, handler, <span class="literal">false</span>);
            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> element.attachEvent != <span class="string">"undefined"</span>) {
                <span class="keyword">var</span> attachEventHandler = <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> {</span> handler.call(element, event); },
                    attachEventName = <span class="string">"on"</span> + eventType;
                element.attachEvent(attachEventName, attachEventHandler);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>IE does not dispose attachEvent handlers automatically (unlike with addEventListener)
so to avoid leaks, we have to remove them manually. See bug #856</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                ko.utils.domNodeDisposal.addDisposeCallback(element, <span class="keyword">function</span>() {
                    element.detachEvent(attachEventName, attachEventHandler);
                });
            } <span class="keyword">else</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Browser doesn't support addEventListener or attachEvent"</span>);
        },

        triggerEvent: <span class="function"><span class="keyword">function</span> <span class="params">(element, eventType)</span> {</span>
            <span class="keyword">if</span> (!(element &amp;&amp; element.nodeType))
                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"element must be a DOM node when calling triggerEvent"</span>);

            <span class="keyword">if</span> (<span class="keyword">typeof</span> jQuery != <span class="string">"undefined"</span>) {
                <span class="keyword">var</span> eventData = [];
                <span class="keyword">if</span> (isClickOnCheckableElement(element, eventType)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Work around the jQuery &quot;click events on checkboxes&quot; issue described above by storing the original checked state before triggering the handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    eventData.push({ checkedStateBeforeEvent: element.checked });
                }
                jQuery(element)[<span class="string">'trigger'</span>](eventType, eventData);
            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> document.createEvent == <span class="string">"function"</span>) {
                <span class="keyword">if</span> (<span class="keyword">typeof</span> element.dispatchEvent == <span class="string">"function"</span>) {
                    <span class="keyword">var</span> eventCategory = knownEventTypesByEventName[eventType] || <span class="string">"HTMLEvents"</span>;
                    <span class="keyword">var</span> event = document.createEvent(eventCategory);
                    event.initEvent(eventType, <span class="literal">true</span>, <span class="literal">true</span>, window, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="number">0</span>, element);
                    element.dispatchEvent(event);
                }
                <span class="keyword">else</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"The supplied element doesn't support dispatchEvent"</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> element.fireEvent != <span class="string">"undefined"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Unlike other browsers, IE doesn&#39;t change the checked state of checkboxes/radiobuttons when you trigger their &quot;click&quot; event
so to make it consistent, we&#39;ll do it manually here</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (isClickOnCheckableElement(element, eventType))
                    element.checked = element.checked !== <span class="literal">true</span>;
                element.fireEvent(<span class="string">"on"</span> + eventType);
            }
            <span class="keyword">else</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Browser doesn't support triggering events"</span>);
        },

        unwrapObservable: <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
            <span class="keyword">return</span> ko.isObservable(value) ? value() : value;
        },

        peekObservable: <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
            <span class="keyword">return</span> ko.isObservable(value) ? value.peek() : value;
        },

        toggleDomNodeCssClass: <span class="function"><span class="keyword">function</span> <span class="params">(node, classNames, shouldHaveClass)</span> {</span>
            <span class="keyword">if</span> (classNames) {
                <span class="keyword">var</span> cssClassNameRegex = <span class="regexp">/\S+/g</span>,
                    currentClassNames = node.className.match(cssClassNameRegex) || [];
                ko.utils.arrayForEach(classNames.match(cssClassNameRegex), <span class="keyword">function</span>(className) {
                    ko.utils.addOrRemoveItem(currentClassNames, className, shouldHaveClass);
                });
                node.className = currentClassNames.join(<span class="string">" "</span>);
            }
        },

        setTextContent: <span class="keyword">function</span>(element, textContent) {
            <span class="keyword">var</span> value = ko.utils.unwrapObservable(textContent);
            <span class="keyword">if</span> ((value === <span class="literal">null</span>) || (value === <span class="literal">undefined</span>))
                value = <span class="string">""</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>We need there to be exactly one child: a text node.
If there are no children, more than one, or if it&#39;s not a text node,
we&#39;ll clear everything and create a single text node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> innerTextNode = ko.virtualElements.firstChild(element);
            <span class="keyword">if</span> (!innerTextNode || innerTextNode.nodeType != <span class="number">3</span> || ko.virtualElements.nextSibling(innerTextNode)) {
                ko.virtualElements.setDomNodeChildren(element, [document.createTextNode(value)]);
            } <span class="keyword">else</span> {
                innerTextNode.data = value;
            }

            ko.utils.forceRefresh(element);
        },

        setElementName: <span class="keyword">function</span>(element, name) {
            element.name = name;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Workaround IE 6/7 issue
- <a href="https://github.com/SteveSanderson/knockout/issues/197">https://github.com/SteveSanderson/knockout/issues/197</a>
- <a href="http://www.matts411.com/post/setting_the_name_attribute_in_ie_dom/">http://www.matts411.com/post/setting_the_name_attribute_in_ie_dom/</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (ieVersion &lt;= <span class="number">7</span>) {
                <span class="keyword">try</span> {
                    element.mergeAttributes(document.createElement(<span class="string">"&lt;input name='"</span> + element.name + <span class="string">"'/&gt;"</span>), <span class="literal">false</span>);
                }
                <span class="keyword">catch</span>(e) {} <span class="comment">// For IE9 with doc mode "IE9 Standards" and browser mode "IE9 Compatibility View"</span>
            }
        },

        forceRefresh: <span class="keyword">function</span>(node) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Workaround for an IE9 rendering bug - <a href="https://github.com/SteveSanderson/knockout/issues/209">https://github.com/SteveSanderson/knockout/issues/209</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (ieVersion &gt;= <span class="number">9</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>For text nodes and comment nodes (most likely virtual elements), we will have to refresh the container</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> elem = node.nodeType == <span class="number">1</span> ? node : node.parentNode;
                <span class="keyword">if</span> (elem.style)
                    elem.style.zoom = elem.style.zoom;
            }
        },

        ensureSelectElementIsRenderedCorrectly: <span class="keyword">function</span>(selectElement) {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Workaround for IE9 rendering bug - it doesn&#39;t reliably display all the text in dynamically-added select boxes unless you force it to re-render by updating the width.
(See <a href="https://github.com/SteveSanderson/knockout/issues/312">https://github.com/SteveSanderson/knockout/issues/312</a>, <a href="http://stackoverflow.com/questions/5908494/select-only-shows-first-char-of-selected-option">http://stackoverflow.com/questions/5908494/select-only-shows-first-char-of-selected-option</a>)
Also fixes IE7 and IE8 bug that causes selects to be zero width if enclosed by &#39;if&#39; or &#39;with&#39;. (See issue #839)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (ieVersion) {
                <span class="keyword">var</span> originalWidth = selectElement.style.width;
                selectElement.style.width = <span class="number">0</span>;
                selectElement.style.width = originalWidth;
            }
        },

        range: <span class="function"><span class="keyword">function</span> <span class="params">(min, max)</span> {</span>
            min = ko.utils.unwrapObservable(min);
            max = ko.utils.unwrapObservable(max);
            <span class="keyword">var</span> result = [];
            <span class="keyword">for</span> (<span class="keyword">var</span> i = min; i &lt;= max; i++)
                result.push(i);
            <span class="keyword">return</span> result;
        },

        makeArray: <span class="keyword">function</span>(arrayLikeObject) {
            <span class="keyword">var</span> result = [];
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = arrayLikeObject.length; i &lt; j; i++) {
                result.push(arrayLikeObject[i]);
            };
            <span class="keyword">return</span> result;
        },

        isIe6 : isIe6,
        isIe7 : isIe7,
        ieVersion : ieVersion,

        getFormFields: <span class="keyword">function</span>(form, fieldName) {
            <span class="keyword">var</span> fields = ko.utils.makeArray(form.getElementsByTagName(<span class="string">"input"</span>)).concat(ko.utils.makeArray(form.getElementsByTagName(<span class="string">"textarea"</span>)));
            <span class="keyword">var</span> isMatchingField = (<span class="keyword">typeof</span> fieldName == <span class="string">'string'</span>)
                ? <span class="keyword">function</span>(field) { <span class="keyword">return</span> field.name === fieldName }
                : <span class="keyword">function</span>(field) { <span class="keyword">return</span> fieldName.test(field.name) }; <span class="comment">// Treat fieldName as regex or object containing predicate</span>
            <span class="keyword">var</span> matches = [];
            <span class="keyword">for</span> (<span class="keyword">var</span> i = fields.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {
                <span class="keyword">if</span> (isMatchingField(fields[i]))
                    matches.push(fields[i]);
            };
            <span class="keyword">return</span> matches;
        },

        parseJson: <span class="function"><span class="keyword">function</span> <span class="params">(jsonString)</span> {</span>
            <span class="keyword">if</span> (<span class="keyword">typeof</span> jsonString == <span class="string">"string"</span>) {
                jsonString = ko.utils.stringTrim(jsonString);
                <span class="keyword">if</span> (jsonString) {
                    <span class="keyword">if</span> (JSON &amp;&amp; JSON.parse) <span class="comment">// Use native parsing where available</span>
                        <span class="keyword">return</span> JSON.parse(jsonString);
                    <span class="keyword">return</span> (<span class="keyword">new</span> Function(<span class="string">"return "</span> + jsonString))(); <span class="comment">// Fallback on less safe parsing for older browsers</span>
                }
            }
            <span class="keyword">return</span> <span class="literal">null</span>;
        },

        stringifyJson: <span class="function"><span class="keyword">function</span> <span class="params">(data, replacer, space)</span> {</span>   <span class="comment">// replacer and space are optional</span>
            <span class="keyword">if</span> (!JSON || !JSON.stringify)
                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Cannot find JSON.stringify(). Some browsers (e.g., IE &lt; 8) don't support it natively, but you can overcome this by adding a script reference to json2.js, downloadable from http://www.json.org/json2.js"</span>);
            <span class="keyword">return</span> JSON.stringify(ko.utils.unwrapObservable(data), replacer, space);
        },

        postJson: <span class="function"><span class="keyword">function</span> <span class="params">(urlOrForm, data, options)</span> {</span>
            options = options || {};
            <span class="keyword">var</span> params = options[<span class="string">'params'</span>] || {};
            <span class="keyword">var</span> includeFields = options[<span class="string">'includeFields'</span>] || <span class="keyword">this</span>.fieldsIncludedWithJsonPost;
            <span class="keyword">var</span> url = urlOrForm;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>If we were given a form, use its &#39;action&#39; URL and pick out any requested field values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span>((<span class="keyword">typeof</span> urlOrForm == <span class="string">'object'</span>) &amp;&amp; (ko.utils.tagNameLower(urlOrForm) === <span class="string">"form"</span>)) {
                <span class="keyword">var</span> originalForm = urlOrForm;
                url = originalForm.action;
                <span class="keyword">for</span> (<span class="keyword">var</span> i = includeFields.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {
                    <span class="keyword">var</span> fields = ko.utils.getFormFields(originalForm, includeFields[i]);
                    <span class="keyword">for</span> (<span class="keyword">var</span> j = fields.length - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--)
                        params[fields[j].name] = fields[j].value;
                }
            }

            data = ko.utils.unwrapObservable(data);
            <span class="keyword">var</span> form = document.createElement(<span class="string">"form"</span>);
            form.style.display = <span class="string">"none"</span>;
            form.action = url;
            form.method = <span class="string">"post"</span>;
            <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> data) {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Since &#39;data&#39; this is a model object, we include all properties including those inherited from its prototype</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> input = document.createElement(<span class="string">"input"</span>);
                input.name = key;
                input.value = ko.utils.stringifyJson(ko.utils.unwrapObservable(data[key]));
                form.appendChild(input);
            }
            objectForEach(params, <span class="keyword">function</span>(key, value) {
                <span class="keyword">var</span> input = document.createElement(<span class="string">"input"</span>);
                input.name = key;
                input.value = value;
                form.appendChild(input);
            });
            document.body.appendChild(form);
            options[<span class="string">'submitter'</span>] ? options[<span class="string">'submitter'</span>](form) : form.submit();
            setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span> form.parentNode.removeChild(form); }, <span class="number">0</span>);
        }
    }
}());

ko.exportSymbol(<span class="string">'utils'</span>, ko.utils);
ko.exportSymbol(<span class="string">'utils.arrayForEach'</span>, ko.utils.arrayForEach);
ko.exportSymbol(<span class="string">'utils.arrayFirst'</span>, ko.utils.arrayFirst);
ko.exportSymbol(<span class="string">'utils.arrayFilter'</span>, ko.utils.arrayFilter);
ko.exportSymbol(<span class="string">'utils.arrayGetDistinctValues'</span>, ko.utils.arrayGetDistinctValues);
ko.exportSymbol(<span class="string">'utils.arrayIndexOf'</span>, ko.utils.arrayIndexOf);
ko.exportSymbol(<span class="string">'utils.arrayMap'</span>, ko.utils.arrayMap);
ko.exportSymbol(<span class="string">'utils.arrayPushAll'</span>, ko.utils.arrayPushAll);
ko.exportSymbol(<span class="string">'utils.arrayRemoveItem'</span>, ko.utils.arrayRemoveItem);
ko.exportSymbol(<span class="string">'utils.extend'</span>, ko.utils.extend);
ko.exportSymbol(<span class="string">'utils.fieldsIncludedWithJsonPost'</span>, ko.utils.fieldsIncludedWithJsonPost);
ko.exportSymbol(<span class="string">'utils.getFormFields'</span>, ko.utils.getFormFields);
ko.exportSymbol(<span class="string">'utils.peekObservable'</span>, ko.utils.peekObservable);
ko.exportSymbol(<span class="string">'utils.postJson'</span>, ko.utils.postJson);
ko.exportSymbol(<span class="string">'utils.parseJson'</span>, ko.utils.parseJson);
ko.exportSymbol(<span class="string">'utils.registerEventHandler'</span>, ko.utils.registerEventHandler);
ko.exportSymbol(<span class="string">'utils.stringifyJson'</span>, ko.utils.stringifyJson);
ko.exportSymbol(<span class="string">'utils.range'</span>, ko.utils.range);
ko.exportSymbol(<span class="string">'utils.toggleDomNodeCssClass'</span>, ko.utils.toggleDomNodeCssClass);
ko.exportSymbol(<span class="string">'utils.triggerEvent'</span>, ko.utils.triggerEvent);
ko.exportSymbol(<span class="string">'utils.unwrapObservable'</span>, ko.utils.unwrapObservable);
ko.exportSymbol(<span class="string">'utils.objectForEach'</span>, ko.utils.objectForEach);
ko.exportSymbol(<span class="string">'utils.addOrRemoveItem'</span>, ko.utils.addOrRemoveItem);
ko.exportSymbol(<span class="string">'unwrap'</span>, ko.utils.unwrapObservable); <span class="comment">// Convenient shorthand, because this is used so commonly</span>

<span class="keyword">if</span> (!Function.prototype[<span class="string">'bind'</span>]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Function.prototype.bind is a standard part of ECMAScript 5th Edition (December 2009, <a href="http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-262.pdf">http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-262.pdf</a>)
In case the browser doesn&#39;t implement it natively, provide a JavaScript implementation. This implementation is based on the one in prototype.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Function.prototype[<span class="string">'bind'</span>] = <span class="function"><span class="keyword">function</span> <span class="params">(object)</span> {</span>
        <span class="keyword">var</span> originalFunction = <span class="keyword">this</span>, args = Array.prototype.slice.call(arguments), object = args.shift();
        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">return</span> originalFunction.apply(object, args.concat(Array.prototype.slice.call(arguments)));
        };
    };
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
